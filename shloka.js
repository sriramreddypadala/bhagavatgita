// Shloka data structure with audio paths
const shlokaData = {
    "shloka1": {
        sanskrit: "अगजानन-पद्मार्कं गजाननम्-अहर्निशम्।\nअनेकदंतं भक्तानाम् एकदंतम् उपास्महे ॥१॥",
        telugu: {
            text: "అగజానన పద్మార్కం గజాననం అహర్నిశం\nఅనేకదంతం భక్తానాం ఏకదంతం ఉపాస్మహే ॥",
            translation: "భక్తులకు అనేక రూపాలలో కనిపించే ఏకదంతుడైన గణేశుని సేవిస్తున్నాము...",
            explanation: "ఈ శ్లోకంలో గణపతి యొక్క వివిధ గుణాలను వర్ణించడం జరిగింది...",
            audio: {
                male: 'audio/shloka1_telugu_male.mp3',
                female: 'audio/shloka1_telugu_female.mp3'
            }
        },
        english: {
            text: "We worship the one-tusked Lord Ganesha...",
            translation: "We meditate upon the elephant-faced Lord...",
            explanation: "This shloka describes various attributes...",
            audio: {
                male: 'audio/shloka1_english_male.mp3',
                female: 'audio/shloka1_english_female.mp3'
            }
        },
        malayalam: {
            text: "അഗജാനന പദ്മാർക്കം ഗജാനനം...",
            translation: "ഭക്తർക്ക് అనേకം రൂపఙ്ങളിൽ...",
            explanation: "ఈ శ్లోకంలో గణపతിയുടെ...",
            audio: {
                male: 'audio/shloka1_malayalam_male.mp3',
                female: 'audio/shloka1_malayalam_female.mp3'
            }
        }
    },
    "shloka2": {
        sanskrit: "अश्रद्दधानाः पुरुषा धर्मस्यास्य परन्तप।\nअप्राप्य मां निवर्तन्ते मृत्युसंसारवर्त्मनि॥",
        telugu: {
            text: "అశ్రద్ధధానాః పురుషా ధర్మస్యాస్య పరంతప |\nఅప్రాప్య మాం నివర్తంతే మృత్యుసంసారవర్త్మని ||",
            translation: "Ashraddadhanah purusha dharmasyasya parantapa,\nApraapya maam nivartante mrityusamsaravartmani.",
            explanation: "",
            audio: {
                male: 'audio/shloka2_telugu_male.mp3',
                female: 'audio/shloka2_telugu_female.mp3'
            }
        },
        english: {
            text: "Ashraddadhanah purusha dharmasyasya parantapa,\nApraapya maam nivartante mrityusamsaravartmani.",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka2_english_male.mp3',
                female: 'audio/shloka2_english_female.mp3'
            }
        },
        malayalam: {
            text: "അശ്രദ്ദധാനാഃ పురుషా ధര്‍മസ്യാസ്യ పరంతప |\nఅప్రాప്യ മാം നിവര്‍ത്തന്തേ മൃത്യുസംസാരവര്‍ത്ത്മനി ||",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka2_malayalam_male.mp3',
                female: 'audio/shloka2_malayalam_female.mp3'
            }
        }
    },
    "shloka3": {
        sanskrit: "मया ततमिदं सर्वं जगदव्यक्तमूर्तिना।\nमस्तानि सर्वभूतानि न चाहं तेष्ववस्थितः॥",
        telugu: {
            text: "మయా తతమిదం సర్వం జగదవ్యక్తమూర్తినా |\nమస్తాని సర్వభూతాని న చాహం తేష్వవస్థితః ||",
            translation: "Maya tatamidam sarvam jagadavyaktamurtina,\nMastani sarvabhutani na chaham tesvavasthitah.",
            explanation: "",
            audio: {
                male: 'audio/shloka3_telugu_male.mp3',
                female: 'audio/shloka3_telugu_female.mp3'
            }
        },
        english: {
            text: "Maya tatamidam sarvam jagadavyaktamurtina,\nMastani sarvabhutani na chaham tesvavasthitah.",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka3_english_male.mp3',
                female: 'audio/shloka3_english_female.mp3'
            }
        },
        malayalam: {
            text: "മയാ തതമിദം സര്വം ജഗദവ്യക്തമൂര്‍ത്തിനാ |\nമസ്താനി സര്വഭൂതാനി ന ചാഹം തേഷ്വവസ്ഥിതഃ ||",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka3_malayalam_male.mp3',
                female: 'audio/shloka3_malayalam_female.mp3'
            }
        }
    },
    "shloka4": {
        sanskrit: "न च मां तानि कर्माणि निबध्नन्ति धनञ्जय।\nउदासीनवदासीनमसक्तं तेषु कर्मसु॥",
        telugu: {
            text: "న చ మాం తాని కర్మాణి నిబధ్నంతి ధనంజయ |\nఉదాసీనవదాసీనమసక్తం తేషు కర్మసు ||",
            translation: "Na cha mam tani karmani nibadhnanti dhananjaya,\nUdaseenavadasinam asaktam teshu karmasu.",
            explanation: "",
            audio: {
                male: 'audio/shloka4_telugu_male.mp3',
                female: 'audio/shloka4_telugu_female.mp3'
            }
        },
        english: {
            text: "Na cha mam tani karmani nibadhnanti dhananjaya,\nUdaseenavadasinam asaktam teshu karmasu.",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka4_english_male.mp3',
                female: 'audio/shloka4_english_female.mp3'
            }
        },
        malayalam: {
            text: "ന చ മാം താനി കര്‍മ്മాണി നിബధ్നംతി ధనంచയ |\nఉదాసీనവദാസീനമസక్తം തേഷു കര്‍മ്മസു ||",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka4_malayalam_male.mp3',
                female: 'audio/shloka4_malayalam_female.mp3'
            }
        }
    },
    "shloka5": {
        sanskrit: "यथाकाशस्थितो नित्यं वायुः सर्वत्रगो महान्।\nतथा सर्वाणि भूतानि मत्स्थानीत्युपधारय॥",
        telugu: {
            text: "యథాకాశస్థితో నిత్యం వాయుః సర్వత్రగో మహాన్ |\nతథా సర్వాణి భూతాని మత్స్థానీత్యుపధారయ ||",
            translation: "Yathakashasthito nityam vayuh sarvatrago mahan,\nTatha sarvani bhutani matsthanityupadharaya.",
            explanation: "",
            audio: {
                male: 'audio/shloka5_telugu_male.mp3',
                female: 'audio/shloka5_telugu_female.mp3'
            }
        },
        english: {
            text: "Yathakashasthito nityam vayuh sarvatrago mahan,\nTatha sarvani bhutani matsthanityupadharaya.",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka5_english_male.mp3',
                female: 'audio/shloka5_english_female.mp3'
            }
        },
        malayalam: {
            text: "യഥാകാശസ്ഥിതോ നിത്യം വായുഃ സര്വത്രഗോ മഹാന് |\nതഥാ സര്വാണി ഭൂതാനി മത്സ്ഥാനീത്യുപധാരയ ||",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka5_malayalam_male.mp3',
                female: 'audio/shloka5_malayalam_female.mp3'
            }
        }
    },
    "shloka6": {
        sanskrit: "सर्वभूतानि कौन्तेय प्रकृतिं यान्ति मामिकाम्।\nकल्पक्षये पुनस्तानि कल्पादौ विसृजाम्यहम्॥",
        telugu: {
            text: "సర్వభూతాని కౌంతేయ ప్రకృతిం యాంతి మామికామ్ |\nకల్పక్షయే పునస్తాని కల్పాదౌ విసృజామ్యహమ్ ||",
            translation: "Sarvabhutani kaunteya prakritim yanti mamikam,\nKalpakshaye punastani kalpadau visrijamyaham.",
            explanation: "",
            audio: {
                male: 'audio/shloka6_telugu_male.mp3',
                female: 'audio/shloka6_telugu_female.mp3'
            }
        },
        english: {
            text: "Sarvabhutani kaunteya prakritim yanti mamikam,\nKalpakshaye punastani kalpadau visrijamyaham.",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka6_english_male.mp3',
                female: 'audio/shloka6_english_female.mp3'
            }
        },
        malayalam: {
            text: "സര്വഭൂതാനി കൗന്തേയ ప్రకൃതിം యాంతി మാമികാം |\nകല്പക്ഷയേ పുനസ്താനി കല്പാദൌ വിസൃജാമ്യഹം ||",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka6_malayalam_male.mp3',
                female: 'audio/shloka6_malayalam_female.mp3'
            }
        }
    },
    "shloka7": {
        sanskrit: "प्रकृतिं स्वामवष्टभ्य विसृजामि पुनः पुनः।\nभूतग्राममिमं कृत्स्नमवशं प्रकृतेर्वशात्॥",
        telugu: {
            text: "ప్రకృతిం స్వామవష్టభ్య విసృజామి పునః పునః |\nభూతగ్రామమిమం కృత్స్నమవశం ప్రకృతఇవశాతః ||",
            translation: "Prakritim swamavashtabhya visrijami punah punah,\nBhutagramamimam kritsnamavasham prakriteh vashat.",
            explanation: "",
            audio: {
                male: 'audio/shloka7_telugu_male.mp3',
                female: 'audio/shloka7_telugu_female.mp3'
            }
        },
        english: {
            text: "Prakritim swamavashtabhya visrijami punah punah,\nBhutagramamimam kritsnamavasham prakriteh vashat.",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka7_english_male.mp3',
                female: 'audio/shloka7_english_female.mp3'
            }
        },
        malayalam: {
            text: "പ്രകൃതിം സ്വാമവഷ്ഠഭ്യ വിസൃജാമി പുനഃ പുനഃ |\nഭൂതഗ്രാമമിമം കൃത്സ്നമവശം പ്രകൃതേവശാത് ||",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka7_malayalam_male.mp3',
                female: 'audio/shloka7_malayalam_female.mp3'
            }
        }
    },
    "shloka8": {
        sanskrit: "न च मां तानि कर्माणि निबध्नन्ति धनञ्जय।\nउदासीनवदासीनमसक्तं तेषु कर्मसु॥",
        telugu: {
            text: "న చ మాం తాని కర్మాణి నిబధ్నంతి ధనంజయ |\nఉదాసీనవదాసీనమసక్తం తేషు కర్మసు ||",
            translation: "Na cha mam tani karmani nibadhnanti dhananjaya,\nUdaseenavadasinam asaktam teshu karmasu.",
            explanation: "",
            audio: {
                male: 'audio/shloka8_telugu_male.mp3',
                female: 'audio/shloka8_telugu_female.mp3'
            }
        },
        english: {
            text: "Na cha mam tani karmani nibadhnanti dhananjaya,\nUdaseenavadasinam asaktam teshu karmasu.",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka8_english_male.mp3',
                female: 'audio/shloka8_english_female.mp3'
            }
        },
        malayalam: {
            text: "ന చ മാം താനി കര്‍മ്മాണി നിബధ్നംతി ధనంచയ |\nఉదాసీనവദാസീനമസక్తം തേഷു കര്‍മ്മസു ||",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka8_malayalam_male.mp3',
                female: 'audio/shloka8_malayalam_female.mp3'
            }
        }
    },
    "shloka9": {
        sanskrit: "मयाध्यक्षेण प्रकृतिः सूयते सचराचरम्।\nहेतुनानेन कौन्तेय जगद्विपरिवर्तते॥",
        telugu: {
            text: "మయాధ్యక్షేణ ప్రకృతిః సూయతే సచరాచరమ్ |\nహేతునానేన కౌంతేయ జగద్విపరివర్తతే ||",
            translation: "Mayadhyakshena prakritih suyate sacharacharam,\nHetunanena kaunteya jagad viparivartate.",
            explanation: "",
            audio: {
                male: 'audio/shloka9_telugu_male.mp3',
                female: 'audio/shloka9_telugu_female.mp3'
            }
        },
        english: {
            text: "Mayadhyakshena prakritih suyate sacharacharam,\nHetunanena kaunteya jagad viparivartate.",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka9_english_male.mp3',
                female: 'audio/shloka9_english_female.mp3'
            }
        },
        malayalam: {
            text: "മയാധ്യക്ഷേണ പ്രകൃതിഃ സൂയതേ സചരാചരം |\nഹേതുനാനേന കൗന്തേയ ജഗദ് വിപരിവര്തതേ ||",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka9_malayalam_male.mp3',
                female: 'audio/shloka9_malayalam_female.mp3'
            }
        }
    },
    "shloka10": {
        sanskrit: "अवजानन्ति मां मूढा मानुषीं तनुमाश्रितम्।\nपरं भावमजानन्तो मम भूतमहेश्वरम्॥",
        telugu: {
            text: "అవజానంతి మాం మూఢా మానుషీం తనుమాశ్రితం |\nపరం భావమజానంతో మమ భూతమహేశ్వరమ్ ||",
            translation: "Avajananti mam mudha manushim tanumashritam,\nParam bhavamajananto mama bhutamaheshwaram.",
            explanation: "",
            audio: {
                male: 'audio/shloka10_telugu_male.mp3',
                female: 'audio/shloka10_telugu_female.mp3'
            }
        },
        english: {
            text: "Avajananti mam mudha manushim tanumashritam,\nParam bhavamajananto mama bhutamaheshwaram.",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka10_english_male.mp3',
                female: 'audio/shloka10_english_female.mp3'
            }
        },
        malayalam: {
            text: "അവജാനന്തി മാം മൂഢാ മാനുഷീം തനുമാശ്രിതം |\nപരം ഭാവമജാനന്തോ മമ ഭൂതമഹേശ്വരം ||",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka10_malayalam_male.mp3',
                female: 'audio/shloka10_malayalam_female.mp3'
            }
        }
    },
    "shloka11": {
        sanskrit: "मोघाशा मोघकर्माणो मोघज्ञाना विचेतसः।\nराक्षसीमासुरीं चैव प्रकृतिं मोहिनीं श्रिताः॥",
        telugu: {
            text: "మొఘాశా మొఘకర్మాణో మొఘజ్ఞానా విచేతసః |\nరాక్షసీమాసురీం చైవ ప్రకృతిం మోహినీం శ్రితాః ||",
            translation: "Moghasha moghakarmano moghajnana vichetasah,\nRakshasim asurim chaiva prakritim mohinim shritah.",
            explanation: "",
            audio: {
                male: 'audio/shloka11_telugu_male.mp3',
                female: 'audio/shloka11_telugu_female.mp3'
            }
        },
        english: {
            text: "Moghasha moghakarmano moghajnana vichetasah,\nRakshasim asurim chaiva prakritim mohinim shritah.",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka11_english_male.mp3',
                female: 'audio/shloka11_english_female.mp3'
            }
        },
        malayalam: {
            text: "മോഘാശാ മോഘകര്‍മ്മാണോ മോഘജ്ഞാനാ വിചേതസഃ |\nരാക്ഷസീമാസുരീം ചൈവ പ്രകൃതിം മോഹിനീം ശ്രിതാഃ ||",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka11_malayalam_male.mp3',
                female: 'audio/shloka11_malayalam_female.mp3'
            }
        }
    },
    "shloka12": {
        sanskrit: "न च मां तानि कर्माणि निबध्नन्ति धनञ्जय।\nउदासीनवदासीनमसक्तं तेषु कर्मसु॥",
        telugu: {
            text: "న చ మాం తాని కర్మాణి నిబధ్నంతి ధనంజయ |\nఉదాసీనవదాసీనమసక్తం తేషు కర్మసు ||",
            translation: "Na cha mam tani karmani nibadhnanti dhananjaya,\nUdaseenavadasinam asaktam teshu karmasu.",
            explanation: "",
            audio: {
                male: 'audio/shloka12_telugu_male.mp3',
                female: 'audio/shloka12_telugu_female.mp3'
            }
        },
        english: {
            text: "Na cha mam tani karmani nibadhnanti dhananjaya,\nUdaseenavadasinam asaktam teshu karmasu.",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka12_english_male.mp3',
                female: 'audio/shloka12_english_female.mp3'
            }
        },
        malayalam: {
            text: "ന చ മാം താനി കര്‍മ്മాണി നിബధ్നംతി ధనంచയ |\nఉదాసీనവദാസീനമസక్తം തേഷു കര്‍മ്മസു ||",
            translation: "",
            explanation: "",
            audio: {
                male: 'audio/shloka12_malayalam_male.mp3',
                female: 'audio/shloka12_malayalam_female.mp3'
            }
        }
    }
    // Add more shlokas if needed
    // ...
};

document.addEventListener('DOMContentLoaded', function() {
    // State management
    let currentState = {
        shloka: 'shloka1',
        language: 'telugu',
        isFemaleVoice: false,
        speed: 1.0,
        volume: 1.0,
        isPlaying: false,
        currentTime: 0,
        lastVolume: 1.0
    };

    // Settings history for undo
    const settingsHistory = {
        stack: [],
        maxSize: 10,
        
        push(state) {
            if (this.stack.length >= this.maxSize) {
                this.stack.shift();
            }
            this.stack.push({...state});
        },
        
        undo() {
            if (this.stack.length > 1) {
                this.stack.pop();
                return {...this.stack[this.stack.length - 1]};
            }
            return null;
        }
    };

    // Initialize elements
    const elements = {
        langButtons: document.querySelectorAll('.lang-btn'),
        shlokaButtons: document.querySelectorAll('.shloka-btn'),
        tabButtons: document.querySelectorAll('.tab-btn'),
        meaningPanels: document.querySelectorAll('.meaning-panel'),
        voiceToggle: document.querySelector('.voice-toggle'),
        speedButtons: document.querySelectorAll('.speed-options button'),
        playBtn: document.querySelector('.play-btn'),
        undoBtn: document.querySelector('.undo-btn'),
        volumeSlider: document.querySelector('.volume-slider'),
        volumeBtn: document.querySelector('.volume-btn'),
        volumePercentage: document.querySelector('.volume-percentage'),
        timeDisplay: document.querySelector('.time-display'),
        sanskritText: document.querySelector('.sanskrit-text'),
        translationText: document.querySelector('.translation-text'),
        explanationText: document.querySelector('.explanation-text')
    };

    // Save initial state
    settingsHistory.push(currentState);

    // Update content based on language
    function updateContent(language) {
        const shloka = shlokaData[currentState.shloka];
        
        // Update Sanskrit text (always visible)
        elements.sanskritText.innerHTML = `
            <div class="original-sanskrit">${shloka.sanskrit}</div>
            <div class="transliteration">${shloka[language].text}</div>
        `;

        // Update translation and explanation
        elements.translationText.innerHTML = shloka[language].translation;
        elements.explanationText.innerHTML = shloka[language].explanation;

        // Update audio source
        updateAudioSource();
    }

    // Audio functionality
    let currentAudio = new Audio();
    
    function updateAudioSource() {
        const shloka = shlokaData[currentState.shloka];
        const gender = currentState.isFemaleVoice ? 'female' : 'male';
        const newSource = shloka[currentState.language].audio[gender];
        
        if (currentAudio.src !== newSource) {
            const wasPlaying = !currentAudio.paused;
            currentAudio.src = newSource;
            currentAudio.playbackRate = currentState.speed;
            currentAudio.volume = currentState.volume;
            if (wasPlaying) {
                currentAudio.play();
            }
        }
    }

    // Event Listeners for all buttons
    
    // 1. Language Buttons
    elements.langButtons.forEach(button => {
        button.addEventListener('click', () => {
            const newLanguage = button.dataset.lang;
            settingsHistory.push({...currentState});
            
            elements.langButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            currentState.language = newLanguage;
            updateContent(newLanguage);
        });
    });

    // 2. Shloka Buttons
    elements.shlokaButtons.forEach(button => {
        button.addEventListener('click', () => {
            const newShloka = 'shloka' + button.dataset.shloka;
            settingsHistory.push({...currentState});
            
            elements.shlokaButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            currentState.shloka = newShloka;
            updateContent(currentState.language);
        });
    });

    // 3. Tab Buttons
    elements.tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const targetTab = button.dataset.tab;
            
            elements.tabButtons.forEach(btn => btn.classList.remove('active'));
            elements.meaningPanels.forEach(panel => panel.classList.remove('active'));
            
            button.classList.add('active');
            document.getElementById(targetTab).classList.add('active');
        });
    });

    // 4. Voice Toggle
    elements.voiceToggle.addEventListener('click', () => {
        settingsHistory.push({...currentState});
        currentState.isFemaleVoice = !currentState.isFemaleVoice;
        elements.voiceToggle.classList.toggle('female');
        updateAudioSource();
    });

    // 5. Speed Buttons
    elements.speedButtons.forEach(button => {
        button.addEventListener('click', () => {
            settingsHistory.push({...currentState});
            
            elements.speedButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            
            currentState.speed = parseFloat(button.dataset.speed);
            currentAudio.playbackRate = currentState.speed;
        });
    });

    // 6. Play Button
    elements.playBtn.addEventListener('click', () => {
        currentState.isPlaying = !currentState.isPlaying;
        
        if (currentState.isPlaying) {
            elements.playBtn.innerHTML = '<span class="play-icon">।।</span>';
            currentAudio.play();
        } else {
            elements.playBtn.innerHTML = '<span class="play-icon">॥</span>';
            currentAudio.pause();
        }
    });

    // 7. Volume Controls
    elements.volumeSlider.addEventListener('input', (e) => {
        settingsHistory.push({...currentState});
        const value = e.target.value / 100;
        
        currentState.volume = value;
        currentAudio.volume = value;
        elements.volumePercentage.textContent = Math.round(value * 100) + '%';
        
        updateVolumeIcon(value);
    });

    elements.volumeBtn.addEventListener('click', () => {
        settingsHistory.push({...currentState});
        
        if (currentState.volume > 0) {
            currentState.lastVolume = currentState.volume;
            currentState.volume = 0;
        } else {
            currentState.volume = currentState.lastVolume || 1;
        }
        
        currentAudio.volume = currentState.volume;
        elements.volumeSlider.value = currentState.volume * 100;
        elements.volumePercentage.textContent = Math.round(currentState.volume * 100) + '%';
        
        updateVolumeIcon(currentState.volume);
    });

    // 8. Undo Button
    elements.undoBtn.addEventListener('click', () => {
        const previousState = settingsHistory.undo();
        if (previousState) {
            currentState = {...previousState};
            updateContent(currentState.language);
        }
    });

    // Initialize with default state
    updateContent(currentState.language);
}); 